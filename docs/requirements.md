# 高機動モバイル販売管理システム

## システムの概要

- いわゆるモバイル端末とサーバで動作するPOSシステム。
- モバイル端末上で、商品・価格マスタの作成、商品の登録、入金、釣り銭の計算を行うことができる。また、1会計ごとに、顧客が購入した商品の種類、個数、金額、入金された金種とその枚数、釣り銭として出金された金種とその枚数を記録する。

## 用語の定義

- POSインスタンス
  商品・価格マスタ、値割引条件、台帳、仮想ドロワの管理は、POSインスタンスごとに行う。
  POSインスタンスは固有の96bitのIDを持ち、そのIDを知っている人のみが使うことができる。
- 商品・価格マスタ
  POSインスタンスで取り扱う商品とその価格、出品者の名前を管理するテーブル。
  商品の価格は変動するので、バージョンを持つ。
- 値割引条件
  - 個数割引：1種類以上の商品を一定数購入すると、それらの商品の分の代金について割引を受けられる。
    個数割引を行うためには、割引適用対象の商品と、割引が適用される条件となる購入数（「割引購入単位数」）と、割引適用対象の商品に対する割引率を設定する。
    割引は合計金額に適用されるわけではなく、割引適用対象の商品の割引購入単位数分のみに適用される。
    個数割引は複数作成することができる。
  - 個数値引：1種類以上の商品を一定数購入すると、合計金額から値引きされる。
    個数値引を行うためには、割引適用対象の商品と、割引が適用される条件となる購入数（「割引購入単位数」）と、値引額を設定する。
    個数値引は複数作成することができる。
- 台帳
  - POSインスタンスに対する次の操作を記録する。
    - 1会計ごとの、商品ごとの購入数、適用された値割引条件の種類とその単位数、入金された金種とその枚数、釣り銭として出金された金種とその枚数。
    - 仮想ドロワに入金された金種とその枚数、入金者の名前
    - 仮想ドロワから出金された金種とその枚数、出金者の名前
    - 上記の各操作の取り消し操作
- 仮想ドロワ
  - POSインスタンスの利用者は1箇所または複数箇所に釣銭準備金を集めてこのシステムを利用している。集まった釣銭準備金はシステム上の仮想のドロワで管理される。これを仮想ドロワと呼ぶ。
  - 仮想ドロワはデータとして存在するわけではない。仮想ドロワのUIに表示される金種とその枚数は、台帳の操作履歴から計算される。

## ユースケース

- POSインスタンスの作成・使用
  - POSインスタンスを作成すると、POSインスタンスごとの96bitのIDが含まれるURLが発行される。
  - POSインスタンスを使用するためには、そのURLにアクセスするか、システムのホーム画面のURL入力欄にURLを入力する。
- メイン画面
  - 上から順に、メニューバー、登録商品一覧表示部、操作部、仮想ドロワ部の4つの部分から成る。
  - メニューバーには、POSインスタンスからホーム画面に戻るためのボタン、台帳画面に移動するためのボタン、商品・価格マスタの作成画面に移動するためのボタンがある。
  - 操作部は会計のフェーズによって表示内容が変わる。
  - 仮想ドロワ部には、仮想ドロワに入金されている金種とその枚数が表示される。また左端に仮想ドロワ入出金画面に遷移するためのボタンがある。
- 会計商品登録画面
  - 操作部の初期状態は、商品登録開始ボタンが表示されているだけ。
  - 商品登録開始ボタンを押すと、操作部に商品の一覧がボタンとして表示される。商品の一覧は1ページあたり3x3で、上部には前後のページに遷移するためのボタンがある。
  - 商品のボタンを1回押すごとにその商品が（商品登録開始時点でのバージョン番号とともに）1つ登録され、登録商品一覧表示部が更新される。
  - 操作部右下の完了ボタンを押すと、次の入金画面に遷移する。
- 会計入金画面
  - 顧客が入金した金種とその枚数を記録する。
  - 金種に対応するボタンを押すごとに、その金種が1枚入金されたことになる。
  - 入金完了ボタンを押すと、サーバ上で、釣銭が出せるかどうかの判定が行われ、受理されれば、台帳にその会計が記録される。
- 会計釣銭画面
  - その会計の釣銭の金種とその枚数を表示する。
  - 出金完了ボタンを押すと、登録商品一覧表示部は空になり、操作部は初期状態に戻る。
- 商品・価格マスタ作成画面
  - 商品・価格マスタの作成と値割引条件の登録を行える。
  - 商品の価格を変更した場合は、商品データのバージョンが変わったことになる。
  - 会計商品登録画面の操作部に表示される商品の並べ替えをスワイプで行うこともできる。
- 台帳画面
  - 台帳の記録内容の一覧を確認できる。また、台帳項目の取り消しを行なった上で、取り消したことの記録を行うことができる。
- 仮想ドロワ入出金画面
  - 釣り銭準備金の入金を行うことができる。
  - 出品者ごとの売上分の出金を行うことができる。
  - 入金者ごとに釣銭準備金の返金を行うことができる。

## 非機能要件

- 技術的な要件
  - シングルページWebアプリケーションとして実装してください。
  - Service Workerを活用して、静的リソースを端末にキャッシュさせてください。またService Workerが静的リソースのバージョン番号を起動時に確認して、キャッシュの更新を行えるようにしてください。
  - オフラインになった場合や、サーバとの接続が切断された場合は、オフラインモードに遷移し、端末の永続ストレージに操作が記録されるようにしてください。
- UIの要件
  - 色は[colors550.json](./colors550.json)の中にあるものを使ってください。
  - メイン画面操作部や仮想ドロワ入出金画面での個数入力は、キーボードだけでなく、画面上のボタンによっても行えるようにしてください。
- 実装の要件
  - データベースはSQLite3とPostgreSQLに対応してください。その際には第1級関数の性質を利用した依存注入を積極的に活用してください。
  - DAOパターンを使ってください。
  - ORMは使わないでください。
  - Dockerコンテナとして動かすことを想定していますので、Dockerfileを書いてください。
  - ルーティングにはFastifyを使ってください。
  - UIの実装にはReact、Tailwind CSS（v4）を使ってください。Reactプロジェクトの開発にはViteを使ってください。
